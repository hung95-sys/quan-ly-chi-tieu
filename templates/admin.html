<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang qu·∫£n tr·ªã - Web Python</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}" defer></script>
</head>

<body>
    <div class="admin-container" data-is-admin="{% if current_user.role == 'admin' %}true{% else %}false{% endif %}">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                <h1>Trang qu·∫£n tr·ªã</h1>
                <div class="header-right">
                    <a href="{{ url_for('main.dashboard') }}" class="admin-home-btn" title="V·ªÅ trang ch·ªß">
                        <span class="admin-home-icon">üè†</span>
                    </a>
                    <div class="user-profile-dropdown">
                        <button class="user-profile-btn" onclick="toggleUserDropdown()">
                            <div class="user-avatar">{{ current_user.name[0].upper() if current_user.name else 'U' }}
                            </div>
                            <span class="user-name-text">{{ current_user.name }}</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdown">
                            <a href="#" onclick="showChangePasswordModal(); return false;" class="dropdown-item">
                                <span class="dropdown-icon">üîë</span>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </a>
                            {% if current_user.role == 'admin' %}
                            <a href="#" class="dropdown-item">
                                <span class="dropdown-icon">‚öôÔ∏è</span>
                                <span>Qu·∫£n tr·ªã</span>
                            </a>
                            {% endif %}
                            <a href="#" onclick="toggleTheme(); return false;" class="dropdown-item">
                                <span class="dropdown-icon" id="theme-icon">üåô</span>
                                <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
                            </a>
                            <a href="{{ url_for('auth.logout') }}" class="dropdown-item">
                                <span class="dropdown-icon">üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Main content -->
        <main class="admin-main">
            <!-- Dashboard cards -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon">üë§</div>
                    <div class="card-content">
                        <h3>Th√¥ng tin t√†i kho·∫£n</h3>
                        <p class="card-value">{{ current_user.username }}</p>
                        <p class="card-label">T√™n ƒëƒÉng nh·∫≠p</p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">üìù</div>
                    <div class="card-content">
                        <h3>H·ªç v√† t√™n</h3>
                        <p class="card-value">{{ current_user.name }}</p>
                        <p class="card-label">T√™n hi·ªÉn th·ªã</p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">üîë</div>
                    <div class="card-content">
                        <h3>Quy·ªÅn h·∫°n</h3>
                        <p class="card-value">{{ current_user.role }}</p>
                        <p class="card-label">Vai tr√≤</p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">üë•</div>
                    <div class="card-content">
                        <h3>T·ªïng ng∆∞·ªùi d√πng</h3>
                        <p class="card-value">{{ all_users|length }}</p>
                        <p class="card-label">S·ªë l∆∞·ª£ng t√†i kho·∫£n</p>
                    </div>
                </div>
            </div>

            <!-- Users table (ch·ªâ hi·ªÉn th·ªã n·∫øu l√† admin) -->
            {% if current_user.role == 'admin' %}
            <div class="admin-section">
                <div class="section-header">
                    <h2>üìä Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
                    <button onclick="showAddUserForm()" class="btn-add">‚ûï Th√™m t√†i kho·∫£n</button>
                </div>

                <!-- Form th√™m/s·ª≠a user (·∫©n m·∫∑c ƒë·ªãnh) -->
                <div id="user-form-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="form-title">Th√™m t√†i kho·∫£n m·ªõi</h3>
                            <button onclick="closeUserForm()" class="btn-close">&times;</button>
                        </div>
                        <form id="user-form" onsubmit="saveUser(event)">
                            <input type="hidden" id="edit-username" name="edit-username" value="">
                            <div class="form-group">
                                <label for="username">T√™n ƒëƒÉng nh·∫≠p *</label>
                                <input type="text" id="username" name="username" required>
                            </div>
                            <div class="form-group">
                                <label for="password">M·∫≠t kh·∫©u *</label>
                                <input type="password" id="password" name="password" required>
                                <small id="password-hint" style="display: none;">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi m·∫≠t
                                    kh·∫©u</small>
                            </div>
                            <div class="form-group">
                                <label for="name">H·ªç v√† t√™n</label>
                                <input type="text" id="name" name="name">
                            </div>
                            <div class="form-group">
                                <label for="role">Vai tr√≤</label>
                                <select id="role" name="role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="active" name="active" checked>
                                    K√≠ch ho·∫°t t√†i kho·∫£n
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="closeUserForm()" class="btn-cancel">H·ªßy</button>
                                <button type="submit" class="btn-save">L∆∞u</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                <th>H·ªç v√† t√™n</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            {% if all_users %}
                            {% for user in all_users %}
                            <tr data-username="{{ user.username }}">
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ user.username }}</strong></td>
                                <td>{{ user.name }}</td>
                                <td><span class="badge badge-{{ user.role }}">{{ user.role }}</span></td>
                                <td>
                                    {% if user.active %}
                                    <span class="status-badge status-active">üü¢ Ho·∫°t ƒë·ªông</span>
                                    {% else %}
                                    <span class="status-badge status-inactive">üî¥ Kh√¥ng ho·∫°t ƒë·ªông</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button onclick="editUser('{{ user.username }}')" class="btn-action btn-edit">‚úèÔ∏è
                                        S·ª≠a</button>
                                    <button onclick="deleteUser('{{ user.username }}')" class="btn-action btn-delete" {%
                                        if user.username==current_user.username %}disabled
                                        title="Kh√¥ng th·ªÉ x√≥a ch√≠nh m√¨nh" {% endif %}>üóëÔ∏è X√≥a</button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Data Management -->
            {% if current_user.role == 'admin' %}
            <div class="admin-section">
                <div class="section-header">
                    <h2>üíæ Qu·∫£n l√Ω d·ªØ li·ªáu</h2>
                </div>
                <div class="data-actions" style="padding: 20px;">
                    <button onclick="exportExcel()" class="btn-add" style="background: #10b981;">üì• Export
                        Excel</button>
                    <button onclick="document.getElementById('import-file').click()" class="btn-add"
                        style="background: #3b82f6; margin-left: 10px;">üì§ Import Excel</button>
                    <input type="file" id="import-file" accept=".xlsx, .xls" style="display: none;"
                        onchange="importExcel(this)">
                </div>
            </div>
            {% endif %}

            <!-- Fund Groups Management (replaces old fund_links) -->
            {% if current_user.role == 'admin' %}
            <div class="admin-section">
                <div class="section-header">
                    <h2>üë• Qu·∫£n l√Ω nh√≥m qu·ªπ</h2>
                    <button onclick="showAddGroupModal()" class="btn-add">‚ûï T·∫°o nh√≥m m·ªõi</button>
                </div>

                <!-- Modal t·∫°o/s·ª≠a nh√≥m qu·ªπ -->
                <div id="fund-group-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="fund-group-modal-title">T·∫°o nh√≥m qu·ªπ m·ªõi</h3>
                            <button onclick="closeGroupModal()" class="btn-close">&times;</button>
                        </div>
                        <form id="fund-group-form" onsubmit="saveGroup(event)">
                            <input type="hidden" id="group-id" value="">
                            <div class="form-group">
                                <label for="group-name">T√™n nh√≥m *</label>
                                <input type="text" id="group-name" name="name" required placeholder="VD: Qu·ªπ Gia ƒê√¨nh">
                            </div>
                            <div class="form-group">
                                <label>Th√†nh vi√™n</label>
                                <div id="group-members-checkboxes" class="checkbox-group">
                                    {% for user in all_users %}
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="members" value="{{ user.id }}"
                                            data-name="{{ user.name }}">
                                        <span>{{ user.name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="closeGroupModal()" class="btn-cancel">H·ªßy</button>
                                <button type="submit" class="btn-save">L∆∞u</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Danh s√°ch nh√≥m qu·ªπ -->
                <div id="fund-groups-list" class="groups-list">
                    <p class="text-center">ƒêang t·∫£i...</p>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- Change Password Modal -->
        <div id="changePasswordModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîë ƒê·ªïi m·∫≠t kh·∫©u</h3>
                    <button onclick="closeChangePasswordModal()" class="btn-close">&times;</button>
                </div>
                <form id="change-password-form" onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label for="current-password">M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                        <input type="password" id="current-password" name="current-password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">M·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="new-password" name="new-password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="confirm-password" name="confirm-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeChangePasswordModal()" class="btn-cancel">H·ªßy</button>
                        <button type="submit" class="btn-save">ƒê·ªïi m·∫≠t kh·∫©u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Qu·∫£n l√Ω ng∆∞·ªùi d√πng
        function showAddUserForm() {
            document.getElementById('form-title').textContent = 'Th√™m t√†i kho·∫£n m·ªõi';
            document.getElementById('user-form').reset();
            document.getElementById('edit-username').value = '';
            document.getElementById('password').required = true;
            document.getElementById('password-hint').style.display = 'none';
            document.getElementById('active').checked = true;
            document.getElementById('user-form-modal').style.display = 'flex';
        }

        function closeUserForm() {
            document.getElementById('user-form-modal').style.display = 'none';
            document.getElementById('user-form').reset();
        }

        function editUser(username) {
            // L·∫•y th√¥ng tin user t·ª´ API
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const user = data.users.find(u => u.username === username);
                    if (user) {
                        document.getElementById('form-title').textContent = 'S·ª≠a t√†i kho·∫£n';
                        document.getElementById('edit-username').value = user.username;
                        document.getElementById('username').value = user.username;
                        document.getElementById('password').value = '';
                        document.getElementById('password').required = false;
                        document.getElementById('password-hint').style.display = 'block';
                        document.getElementById('name').value = user.name;
                        document.getElementById('role').value = user.role;
                        document.getElementById('active').checked = user.active;
                        document.getElementById('user-form-modal').style.display = 'flex';
                    }
                })
                .catch(error => {
                    alert('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng: ' + error);
                });
        }

        function saveUser(event) {
            event.preventDefault();

            const formData = {
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value.trim(),
                name: document.getElementById('name').value.trim(),
                role: document.getElementById('role').value,
                active: document.getElementById('active').checked
            };

            const editUsername = document.getElementById('edit-username').value;
            const isEdit = editUsername !== '';

            // N·∫øu l√† s·ª≠a v√† kh√¥ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi, kh√¥ng g·ª≠i password
            if (isEdit && !formData.password) {
                delete formData.password;
            }

            const url = isEdit ? `/api/users/${editUsername}` : '/api/users';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                    }
                })
                .catch(error => {
                    alert('L·ªói: ' + error);
                });
        }

        function deleteUser(username) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?`)) {
                return;
            }

            fetch(`/api/users/${username}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                    }
                })
                .catch(error => {
                    alert('L·ªói: ' + error);
                });
        }

        // User dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // ƒê√≥ng dropdown khi click b√™n ngo√†i
        window.onclick = function (event) {
            const modal = document.getElementById('user-form-modal');
            if (event.target == modal) {
                closeUserForm();
            }

            const passwordModal = document.getElementById('changePasswordModal');
            if (event.target == passwordModal) {
                closeChangePasswordModal();
            }

            const groupModal = document.getElementById('fund-group-modal');
            if (event.target == groupModal) {
                closeGroupModal();
            }

            if (!event.target.matches('.user-profile-btn') && !event.target.closest('.user-profile-dropdown')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            }
        }

        // Change password
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('change-password-form').reset();
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        function changePassword(event) {
            event.preventDefault();

            const formData = {
                current_password: document.getElementById('current-password').value.trim(),
                new_password: document.getElementById('new-password').value.trim(),
                confirm_password: document.getElementById('confirm-password').value.trim()
            };

            fetch('/api/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        closeChangePasswordModal();
                    } else {
                        alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                    }
                })
                .catch(error => {
                    alert('L·ªói: ' + error);
                });
        }

        // ============================================
        // Qu·∫£n l√Ω nh√≥m qu·ªπ (Fund Groups)
        // ============================================

        function showAddGroupModal() {
            document.getElementById('group-id').value = '';
            document.getElementById('group-name').value = '';
            document.getElementById('fund-group-modal-title').textContent = 'T·∫°o nh√≥m qu·ªπ m·ªõi';
            document.querySelectorAll('#group-members-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('fund-group-modal').style.display = 'flex';
        }

        function closeGroupModal() {
            document.getElementById('fund-group-modal').style.display = 'none';
        }

        function loadFundGroups() {
            fetch('/api/fund_groups/all')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('fund-groups-list');
                    if (data.groups && data.groups.length > 0) {
                        container.innerHTML = data.groups.map(group => `
                            <div class="group-card">
                                <div class="group-header">
                                    <h3 class="group-name">${group.name}</h3>
                                    <div class="group-actions">
                                        <button onclick="editGroup(${group.id}, '${group.name}')" class="btn-action btn-edit">‚úèÔ∏è</button>
                                        <button onclick="deleteGroup(${group.id})" class="btn-action btn-delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="group-members">
                                    <span class="members-label">Th√†nh vi√™n:</span>
                                    ${group.members.map(m => `<span class="member-tag">${m.name}</span>`).join('')}
                                </div>
                                <div class="group-meta">
                                    <small>T·∫°o b·ªüi: ${group.created_by} | ${group.created_at}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="text-center no-data">Ch∆∞a c√≥ nh√≥m qu·ªπ n√†o. H√£y t·∫°o nh√≥m m·ªõi!</p>';
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi t·∫£i nh√≥m qu·ªπ:', error);
                    document.getElementById('fund-groups-list').innerHTML = '<p class="text-center text-error">L·ªói khi t·∫£i d·ªØ li·ªáu</p>';
                });
        }

        function editGroup(groupId, groupName) {
            document.getElementById('group-id').value = groupId;
            document.getElementById('group-name').value = groupName;
            document.getElementById('fund-group-modal-title').textContent = 'Ch·ªânh s·ª≠a nh√≥m qu·ªπ';

            fetch(`/api/fund_groups/${groupId}/members`)
                .then(response => response.json())
                .then(data => {
                    const memberIds = data.members.map(m => m.id);
                    document.querySelectorAll('#group-members-checkboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = memberIds.includes(parseInt(cb.value));
                    });
                    document.getElementById('fund-group-modal').style.display = 'flex';
                });
        }

        function saveGroup(event) {
            event.preventDefault();

            const groupId = document.getElementById('group-id').value;
            const name = document.getElementById('group-name').value.trim();
            const memberCheckboxes = document.querySelectorAll('#group-members-checkboxes input[type="checkbox"]:checked');
            const memberIds = Array.from(memberCheckboxes).map(cb => parseInt(cb.value));

            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
                return;
            }

            if (memberIds.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 th√†nh vi√™n');
                return;
            }

            if (groupId) {
                fetch(`/api/fund_groups/${groupId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateGroupMembers(groupId, memberIds);
                        } else {
                            alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                        }
                    });
            } else {
                fetch('/api/fund_groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, member_ids: memberIds })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('T·∫°o nh√≥m qu·ªπ th√†nh c√¥ng!');
                            closeGroupModal();
                            loadFundGroups();
                        } else {
                            alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                        }
                    })
                    .catch(error => alert('L·ªói: ' + error));
            }
        }

        async function updateGroupMembers(groupId, newMemberIds) {
            try {
                const response = await fetch(`/api/fund_groups/${groupId}/members`);
                const data = await response.json();
                const currentMemberIds = data.members.map(m => m.id);

                for (const id of currentMemberIds) {
                    if (!newMemberIds.includes(id)) {
                        await fetch(`/api/fund_groups/${groupId}/members/${id}`, { method: 'DELETE' });
                    }
                }

                for (const id of newMemberIds) {
                    if (!currentMemberIds.includes(id)) {
                        await fetch(`/api/fund_groups/${groupId}/members`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: id })
                        });
                    }
                }

                alert('C·∫≠p nh·∫≠t nh√≥m qu·ªπ th√†nh c√¥ng!');
                closeGroupModal();
                loadFundGroups();
            } catch (error) {
                alert('L·ªói c·∫≠p nh·∫≠t th√†nh vi√™n: ' + error);
            }
        }

        function deleteGroup(groupId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m qu·ªπ n√†y?')) return;

            fetch(`/api/fund_groups/${groupId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadFundGroups();
                    } else {
                        alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                    }
                })
                .catch(error => alert('L·ªói: ' + error));
        }

        function exportExcel() {
            window.location.href = '/api/export/excel';
        }

        function importExcel(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën import file "${file.name}"?`)) {
                input.value = '';
                return;
            }

            const btn = input.previousElementSibling;
            const originalText = btn.innerText;
            btn.innerText = '‚è≥ ƒêang x·ª≠ l√Ω...';
            btn.disabled = true;

            fetch('/api/import/excel', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let msg = data.message;
                        if (data.errors && data.errors.length > 0) {
                            msg += '\n\nC·∫£nh b√°o l·ªói:\n' + data.errors.slice(0, 5).join('\n') + (data.errors.length > 5 ? '\n...' : '');
                        }
                        alert(msg);
                        location.reload();
                    } else {
                        alert('L·ªói: ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                    }
                })
                .catch(error => alert('L·ªói: ' + error))
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    input.value = '';
                });
        }


        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('fund-groups-list')) {
                loadFundGroups();
            }
        });

    </script>
</body>

</html>